"use strict";angular.module("sandglitch").directive("ngImageCompress",["$q",function(e){var t=window.URL||window.webkitURL,i=function(){var e="fileupload-resize-area",t=document.getElementById(e);return t||(t=document.createElement("canvas"),t.id=e,t.style.visibility="hidden",document.body.appendChild(t)),t},a=function(e,t){var i=t.resizeType,a=100*t.resizeQuality||70,n="image/jpeg";void 0!==i&&"png"===i&&(n="image/png");var r=t.resizeMaxHeight||300,o=t.resizeMaxWidth||250,d=e.height,u=e.width;u>d?u>o&&(d=Math.round(d*=o/u),u=o):d>r&&(u=Math.round(u*=r/d),d=r);var c=document.createElement("canvas");c.width=u,c.height=d;var s=c.getContext("2d").drawImage(e,0,0,u,d),g=c.toDataURL(n,a/100),h=new Image;return h.src=g,h.src},n=function(e,t){var a=t.resizeMaxHeight||300,n=t.resizeMaxWidth||250,r=t.resizeQuality||.7,o=t.resizeType||"image/jpg",d=i(),u=e.height,c=e.width;c>u?c>n&&(u=Math.round(u*=n/c),c=n):u>a&&(c=Math.round(c*=a/u),u=a),d.width=c,d.height=u;var s=d.getContext("2d");return s.drawImage(e,0,0,c,u),d.toDataURL(o,r)},r=function(e,t){var i=new Image;i.onload=function(){t(i)},i.src=e},o=function(t){var i=e.defer(),a=new FileReader;return a.onload=function(e){i.resolve(e.target.result)},a.readAsDataURL(t),i.promise};return{restrict:"A",scope:{image:"=",resizeMaxHeight:"@?",resizeMaxWidth:"@?",resizeQuality:"@?",resizeType:"@?"},link:function d(e,i,n){var d=function(t,i){r(t.url,function(n){var r=a(n,e);t.compressed={dataURL:r,type:r.match(/:(.+\/.+);/)[1]},i(t)})},u=function(t){e.$apply(function(){n.multiple?e.image.push(t):e.image=t})};i.bind("change",function(i){n.multiple&&(e.image=[]);for(var a=i.target.files,r=0;r<a.length;r++){var c={file:a[r],url:t.createObjectURL(a[r])};o(a[r]).then(function(e){c.dataURL=e}),e.resizeMaxHeight||e.resizeMaxWidth?d(c,function(e){u(e)}):u(c)}})}}}]);